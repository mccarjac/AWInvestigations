name: Build Android APK

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Build Android APK
        id: build_apk
        run: |
          echo "Starting EAS build for Android APK..."
          # Submit build and wait for completion
          BUILD_OUTPUT=$(eas build --platform android --profile preview --non-interactive --wait --json)
          echo "$BUILD_OUTPUT"

          # Extract build ID and artifacts URL
          BUILD_ID=$(echo "$BUILD_OUTPUT" | jq -r '.[0].id')
          ARTIFACTS_URL=$(echo "$BUILD_OUTPUT" | jq -r '.[0].artifacts.buildUrl')
          BUILD_STATUS=$(echo "$BUILD_OUTPUT" | jq -r '.[0].status')

          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "artifacts_url=$ARTIFACTS_URL" >> $GITHUB_OUTPUT
          echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT

          if [ "$BUILD_STATUS" != "FINISHED" ]; then
            echo "❌ Build did not complete successfully. Status: $BUILD_STATUS"
            exit 1
          fi

          echo "✅ Build completed successfully!"
          echo "Build ID: $BUILD_ID"
          echo "Download URL: $ARTIFACTS_URL"

      - name: Create GitHub Release
        if: steps.build_apk.outputs.build_status == 'FINISHED'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.sha }}
          name: APK Build ${{ github.run_number }}
          body: |
            ## Android APK Build

            **Build Details:**
            - Commit: ${{ github.sha }}
            - Build ID: ${{ steps.build_apk.outputs.build_id }}
            - Profile: preview
            - Platform: Android

            **Download APK:**
            [Download APK](${{ steps.build_apk.outputs.artifacts_url }})

            This build was automatically generated from commit ${{ github.sha }}.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
